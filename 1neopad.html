<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neopad Pediatric Calculator</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light: #ecf0f1;
            --border: #bdc3c7;
            --secondary-text: #e67e22;
            --age-text: #7f8c8d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            font-size: 14px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: var(--primary);
            margin-top: 0;
            font-size: 1.5rem; 
            text-align: center; 
            margin-bottom: 5px; 
        }
        .brand { 
            font-size: 0.8rem; 
            color: #7f8c8d; 
            text-align: center; 
            display: block; 
            margin-bottom: 20px; 
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            background-color: var(--light);
            border-radius: 6px;
            margin-bottom: 20px;
            margin-top: 20px;
        }
        .input-wrapper { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; }
        input, select { padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; }
        input:focus { border-color: var(--accent); outline: none; }

        .section-header {
            background-color: var(--primary);
            color: white;
            padding: 8px 12px;
            margin: 20px 0 10px 0;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .result-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #eee; }
        .result-label { color: #555; font-weight: 500; flex: 1; padding-top: 2px; }
        .result-value { font-weight: 700; color: var(--primary); text-align: right; line-height: 1.4; flex: 1.5; display: flex; flex-direction: column; align-items: flex-end; }
        .sub-header { font-weight: bold; color: var(--accent); margin-top: 10px; border-bottom: 2px solid var(--accent); display: inline-block; }
        
        /* Dual Calculation Styling */
        .calc-weight { color: var(--primary); }
        .calc-age { font-size: 0.9em; color: var(--secondary-text); font-weight: 600; }
        .calc-label { font-size: 0.75em; color: #95a5a6; text-transform: uppercase; margin-right: 4px; font-weight: normal; }
        .color-text { font-weight: 900; text-shadow: 0 0 1px rgba(0,0,0,0.1); }

        .pbw-box { background: #e8f6f3; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #a3e4d7; }

        .bp-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .bp-btn:hover { background-color: #2980b9; }

        /* New Hypotension Styles */
        .hypo-box {
            background: #fff8e1;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #ffe0b2;
            color: #4e342e;
            font-size: 0.9em;
        }
        .hypo-list {
            margin: 5px 0 10px 0;
            padding-left: 20px;
        }
        .hypo-calc-result {
            font-weight: bold;
            color: #d35400;
            font-size: 1.1em;
        }
        .hypo-footnote {
            font-size: 50%;
            opacity: 0.5;
            margin-top: 5px;
            line-height: 1.2;
        }

        .manual-toggle-group {
            display:flex; 
            align-items:center; 
            gap:5px; 
            margin-top:2px;
        }
        .manual-label {
            font-size:0.75em; 
            margin:0; 
            display:flex; 
            align-items:center; 
            gap:3px; 
            color:#7f8c8d; 
            font-weight:normal; 
            cursor:pointer;
        }
        .manual-input {
            width:50px; 
            padding:2px 4px; 
            font-size:0.85em; 
            border:1px solid #bdc3c7; 
            border-radius:3px; 
            display:none;
        }

        @media (max-width: 600px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Neopad Anestesi UGM</h1>
    <span class="brand"> </span>

    <div id="calculatorWrapper">
        <div class="input-group">
            <div class="input-wrapper">
                <label>Usia (Tahun)</label>
                <input type="number" id="ageYear" min="0" placeholder="0" oninput="calculate()">
            </div>
            <div class="input-wrapper">
                <label>Usia (Bulan)</label>
                <input type="number" id="ageMonth" min="0" max="11" placeholder="0" oninput="calculate()">
            </div>
            <div class="input-wrapper">
                <label>Berat Badan (kg)</label>
                <input type="number" id="weight" step="0.1" placeholder="kg" oninput="calculate()">
            </div>
            <div class="input-wrapper">
                <label>Tinggi Badan (cm)</label>
                <input type="number" id="height" placeholder="cm" oninput="calculate()">
            </div>
            <div class="input-wrapper">
                <label>Gender</label>
                <select id="gender" onchange="calculate()">
                    <option value="male">Laki-laki</option>
                    <option value="female">Perempuan</option>
                </select>
            </div>
            <div class="input-wrapper">
                <label>PP (Jam)</label>
                <input type="number" id="ppHours" value="8" oninput="calculate()">
            </div>
            <div class="input-wrapper">
                <label>REL</label>
                <select id="relFactor" onchange="calculate()">
                    <option value="2">Noninvasive (2 ml/kg)</option>
                    <option value="4" selected>Mildly invasive (4 ml/kg)</option>
                    <option value="8">Moderately invasive (8 ml/kg)</option>
                    <option value="10">Significantly invasive (≥10 ml/kg)</option>
                </select>
            </div>
            <div class="input-wrapper">
                <label>Hct Awal (%)</label>
                <input type="number" id="hctInit" step="0.1" placeholder="ex: 36" oninput="calculate()">
            </div>
        </div>

        <div class="pbw-box">
            <div class="result-row" style="border:none;">
                <span class="result-label">Predicted Body Weight for ADULTS (PBW)</span>
                <span id="resPBW" class="result-value">-</span>
            </div>
            <div class="result-row" style="border:none; margin-top: 5px;">
                <span class="result-label">Predicted Weight (WHO/CDC P25-P75)</span>
                <span id="resEstWeight" class="result-value">-</span>
            </div>
        </div>

        <div class="section-header">DEVICE (Airway)</div>
        <div class="grid-2">
            <div class="result-row"><span class="result-label">Mask Type</span><span id="resMask" class="result-value">-</span></div>
            <div class="result-row"><span class="result-label">Oral Airway (Guedel)</span><span id="resOPA" class="result-value">-</span></div>
            <div class="result-row"><span class="result-label">Blade</span><span id="resBlade" class="result-value">-</span></div>
            <div class="result-row"><span class="result-label">Suction Catheter</span><span id="resSuction" class="result-value">-</span></div>
            <div class="result-row" style="align-items: flex-start;">
                <span class="result-label">ETT Size</span>
                <span id="resETT" class="result-value">-</span>
            </div>
            <div class="result-row"><span class="result-label">ETT Depth (cm)</span><span id="resDepth" class="result-value">-</span></div>
            <div class="result-row"><span class="result-label">LMA Size</span><span id="resLMA" class="result-value">-</span></div>
        </div>

        <div class="section-header">HEMODINAMIK & RESPIRASI</div>
        <a href="https://bsolomon.us/app/pediatric-bp/" target="_blank" class="bp-btn">BP CALCULATOR FOR PEDIATRICS</a>
        
        <div class="hypo-box">
            <strong>Hypotension Definition (Systolic BP):</strong>
            <ul class="hypo-list">
                <li>&lt;60 mm Hg: Term neonates (0 to 28 days)</li>
                <li>&lt;70 mm Hg: Infants (1 month to 12 months)</li>
                <li>&lt;70 mm Hg + (2 × age in years): Children 1 to 10 years</li>
                <li>&lt;90 mm Hg: Children ≥10 years of age</li>
            </ul>
            <div style="border-top: 1px dashed #ccc; padding-top: 5px; margin-top: 5px;">
                Patient Minimum SBP: <span id="resMinSBP" class="hypo-calc-result">-</span>
            </div>
            <div class="hypo-footnote">
                <a href="https://doi.org/10.1161/CIRCULATIONAHA.110.971101" target="_blank" style="color: inherit; text-decoration: none;">
                    https://doi.org/10.1161/CIRCULATIONAHA.110.971101
                </a>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="result-row"><span class="result-label">Heart Rate (HR)</span><span id="resHR" class="result-value">-</span></div>
            <div class="result-row"><span class="result-label">Resp. Rate (RR)</span><span id="resRR" class="result-value">-</span></div>
        </div>

        <div class="result-row"><span class="result-label">Tidal Volume (VT)</span><span id="resVT" class="result-value">-</span></div>

        <div class="result-row">
            <span class="result-label">MV Factor (ml/kg/min)</span>
            <span class="result-value">
                <span id="resMVFactor">-</span>
                <div class="manual-toggle-group">
                    <label class="manual-label">
                        <input type="checkbox" id="mvOverrideToggle" onchange="calculate()">
                        Manual
                    </label>
                    <input type="number" id="mvOverrideValue"
                           class="manual-input"
                           placeholder="ml/kg"
                           oninput="calculate()">
                </div>
            </span>
        </div>
        
        <div class="result-row"><span class="result-label">Minute Vol Total (MV)</span><span id="resMV" class="result-value">-</span></div>


        <div class="section-header">CAIRAN & DARAH</div>
        
        <div class="result-row">
            <span class="result-label">EBV Factor</span>
            <span class="result-value">
                <span id="resEBVFactor">-</span>
                <div class="manual-toggle-group">
                    <label class="manual-label">
                        <input type="checkbox" id="ebvOverrideToggle" onchange="calculate()">
                        Manual
                    </label>
                    <input type="number" id="ebvOverrideValue"
                           class="manual-input"
                           placeholder="ml/kg"
                           oninput="calculate()">
                </div>
            </span>
        </div>

        <div class="result-row"><span class="result-label">EBV (Estimated Blood Vol)</span><span id="resEBV" class="result-value">-</span></div>
        <div class="sub-header" style="width:100%; border-bottom:1px solid #eee; margin-bottom:5px;">MABL (Max Allowable Blood Loss)</div>
        <div id="ablSection"></div>
        <div style="font-size: 0.75em; color: #7f8c8d; margin-top:5px; text-align:right; width:100%; display:block;">Formula: EBV × (Hct Init - Hct Thr) / Hct Init</div>
        
        <div class="sub-header">Fluid Management</div>
        <div class="result-row"><span class="result-label">Maintenance (2 cc/kgBW/hr)</span><span id="resMaint" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">Replacement (REL)</span><span id="resREL" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">PP (Pengganti Puasa)</span><span id="resPP" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">KC 1 (Jam 1: M + REL + 1/2 PP)</span><span id="resKC1" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">KC 2-3 (Jam 2/3: M + REL + 1/4 PP)</span><span id="resKC2" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">KC 4 (Jam 4: M + REL)</span><span id="resKC4" class="result-value">-</span></div>
        
        <div class="section-header">MEDICATION (KALKULATOR INI TIDAK PUNYA UPPER LIMIT)</div>
        <div id="medsList"></div>

        <div class="section-header">EMERGENCY</div>
        <div class="result-row"><span class="result-label">Epinephrine (10 mcg/kg)</span><span id="resEpi" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">Ephedrine (0.1-0.3 mg/kg)</span><span id="resEphedrine" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">Atropine (0.01-0.02 mg/kg)</span><span id="resAtropine" class="result-value">-</span></div>

        <div class="section-header">CAUDAL</div>
        <div class="result-row"><span class="result-label">Armitage (0.5 ml/kg)</span><span id="resArmitageLow" class="result-value">-</span></div>
        <div class="result-row"><span class="result-label">Armitage (1.0 ml/kg)</span><span id="resArmitageHigh" class="result-value">-</span></div>
    </div> 
</div>

<script>
    // --- PEDIATRIC CALC LOGIC ---
    // [0] = age in months
    // [1] = P25 weight (kg)
    // [2] = P75 weight (kg)
    const growthData = {
        female: [
            [0.0, 2.4, 4.2], [1.0, 3.2, 5.5], [2.0, 3.9, 6.6], [3.0, 4.5, 7.5], [4.0, 5.0, 8.2], [5.0, 5.4, 8.8], [6.0, 5.7, 9.3], [7.0, 6.0, 9.8], [8.0, 6.3, 10.2], [9.0, 6.5, 10.5], [10.0, 6.7, 10.9], [11.0, 6.9, 11.2], [12.0, 7.0, 11.5], [13.0, 7.2, 11.8], [14.0, 7.4, 12.1], [15.0, 7.6, 12.4], [16.0, 7.7, 12.6], [17.0, 7.9, 12.9], [18.0, 8.1, 13.2], [19.0, 8.2, 13.5], [20.0, 8.4, 13.7], [21.0, 8.6, 14.0], [22.0, 8.7, 14.3], [23.0, 8.9, 14.6], [24.0, 9.0, 14.8], [25.0, 9.2, 15.1], [26.0, 9.4, 15.4], [27.0, 9.5, 15.7], [28.0, 9.7, 16.0], [29.0, 9.8, 16.2], [30.0, 10.0, 16.5], [31.0, 10.1, 16.8], [32.0, 10.3, 17.1], [33.0, 10.4, 17.3], [34.0, 10.5, 17.6], [35.0, 10.7, 17.9], [36.0, 10.8, 18.1], [37.0, 10.9, 18.4], [38.0, 11.1, 18.7], [39.0, 11.2, 19.0], [40.0, 11.3, 19.2], [41.0, 11.5, 19.5], [42.0, 11.6, 19.8], [43.0, 11.7, 20.1], [44.0, 11.8, 20.4], [45.0, 12.0, 20.7], [46.0, 12.1, 20.9], [47.0, 12.2, 21.2], [48.0, 12.3, 21.5], [49.0, 12.4, 21.8], [50.0, 12.6, 22.1], [51.0, 12.7, 22.4], [52.0, 12.8, 22.6], [53.0, 12.9, 22.9], [54.0, 13.0, 23.2], [55.0, 13.2, 23.5], [56.0, 13.3, 23.8], [57.0, 13.4, 24.1], [58.0, 13.5, 24.4], [59.0, 13.6, 24.6], [60.0, 13.7, 24.9], [72.5, 18.499, 22.663], [84.5, 20.672, 25.675], [96.5, 23.094, 29.170], [108.5, 25.902, 33.294], [120.5, 29.171, 38.039], [132.5, 32.852, 43.187], [144.5, 36.750, 48.334], [156.5, 40.556, 52.997], [168.5, 43.940, 56.764], [180.5, 46.654, 59.444], [192.5, 48.620, 61.162], [204.5, 49.959, 62.328], [216.5, 50.950, 63.443], [228.5, 51.847, 64.778]
        ],
        male: [
            [0.0, 2.5, 4.4], [1.0, 3.4, 5.8], [2.0, 4.3, 7.1], [3.0, 5.0, 8.0], [4.0, 5.6, 8.7], [5.0, 6.0, 9.3], [6.0, 6.4, 9.8], [7.0, 6.7, 10.3], [8.0, 6.9, 10.7], [9.0, 7.1, 11.0], [10.0, 7.4, 11.4], [11.0, 7.6, 11.7], [12.0, 7.7, 12.0], [13.0, 7.9, 12.3], [14.0, 8.1, 12.6], [15.0, 8.3, 12.8], [16.0, 8.4, 13.1], [17.0, 8.6, 13.4], [18.0, 8.8, 13.7], [19.0, 8.9, 13.9], [20.0, 9.1, 14.2], [21.0, 9.2, 14.5], [22.0, 9.4, 14.7], [23.0, 9.5, 15.0], [24.0, 9.7, 15.3], [25.0, 9.8, 15.5], [26.0, 10.0, 15.8], [27.0, 10.1, 16.1], [28.0, 10.2, 16.3], [29.0, 10.4, 16.6], [30.0, 10.5, 16.9], [31.0, 10.7, 17.1], [32.0, 10.8, 17.4], [33.0, 10.9, 17.6], [34.0, 11.0, 17.8], [35.0, 11.2, 18.1], [36.0, 11.3, 18.3], [37.0, 11.4, 18.6], [38.0, 11.5, 18.8], [39.0, 11.6, 19.0], [40.0, 11.8, 19.3], [41.0, 11.9, 19.5], [42.0, 12.0, 19.7], [43.0, 12.1, 20.0], [44.0, 12.2, 20.2], [45.0, 12.4, 20.5], [46.0, 12.5, 20.7], [47.0, 12.6, 20.9], [48.0, 12.7, 21.2], [49.0, 12.8, 21.4], [50.0, 12.9, 21.7], [51.0, 13.1, 21.9], [52.0, 13.2, 22.2], [53.0, 13.3, 22.4], [54.0, 13.4, 22.7], [55.0, 13.5, 22.9], [56.0, 13.6, 23.2], [57.0, 13.7, 23.4], [58.0, 13.8, 23.7], [59.0, 14.0, 23.9], [60.0, 14.1, 24.2], [72.5, 19.001, 22.940], [84.5, 21.095, 25.759], [96.5, 23.340, 28.847], [108.5, 25.830, 32.397], [120.5, 28.669, 36.559], [132.5, 31.979, 41.384], [144.5, 35.868, 46.813], [156.5, 40.556, 52.997], [168.5, 43.940, 56.764], [180.5, 46.654, 59.444], [192.5, 48.620, 61.162], [204.5, 49.959, 62.328], [216.5, 50.950, 63.443], [228.5, 62.457, 77.586]
        ]
    };

    // Updated according to CSV A
    // Retaining OPA Color logic: Mapping Size -> Color/Mm manually
    const AIRWAY_BY_WEIGHT = [
        { min: -1, max: 1, mask: "00", opaSize: "00", opaMm: "40", opaColor: "Pink", blade: "Miller 0", suction: "6", ett: "2.5u", depth: "7", lma: "1" },
        { min: 1, max: 2, mask: "00", opaSize: "00", opaMm: "40", opaColor: "Pink", blade: "Miller 0", suction: "6", ett: "3.0u", depth: "8", lma: "1" },
        { min: 2, max: 3, mask: "00", opaSize: "00", opaMm: "40", opaColor: "Pink", blade: "Miller 0-1", suction: "6", ett: "3c/3.5u", depth: "9", lma: "1" },
        { min: 3, max: 4, mask: "0", opaSize: "1", opaMm: "60", opaColor: "Black", blade: "Miller 0-1", suction: "6", ett: "3c/3.5u", depth: "10", lma: "1" },
        { min: 4, max: 6, mask: "0", opaSize: "1", opaMm: "60", opaColor: "Black", blade: "Miller 1/Wis 1.5", suction: "8", ett: "3c/3.5", depth: "12", lma: "1-1.5" },
        { min: 6, max: 10, mask: "1", opaSize: "0", opaMm: "50", opaColor: "Lt Blue", blade: "Wis 1.5", suction: "8", ett: "3.5c/4u", depth: "13", lma: "1.5" },
        { min: 10, max: 12, mask: "1", opaSize: "1", opaMm: "60", opaColor: "Black", blade: "Wis 1.5", suction: "8", ett: "4-4.5c", depth: "14", lma: "2" },
        { min: 12, max: 16, mask: "2", opaSize: "1", opaMm: "60", opaColor: "Black", blade: "Wis 1.5/Mac 2", suction: "10", ett: "4.5c", depth: "15", lma: "2" },
        { min: 16, max: 20, mask: "2", opaSize: "1-2", opaMm: "60-70", opaColor: "Black/White", blade: "Miller 2/Mac 2", suction: "10", ett: "4.5-5c", depth: "16", lma: "2" },
        { min: 20, max: 30, mask: "2", opaSize: "2-3", opaMm: "70-80", opaColor: "White/Green", blade: "Miller 2/Mac 2", suction: "10", ett: "5-5.5c", depth: "17", lma: "2.5" },
        { min: 30, max: 45, mask: "3", opaSize: "3", opaMm: "80", opaColor: "Green", blade: "Miller/Mac 2-3", suction: "12", ett: "5.5-6c", depth: "18", lma: "3" },
        { min: 45, max: 9999, mask: "4", opaSize: "3-4", opaMm: "80-90", opaColor: "Green/Yellow", blade: "Miller/Mac 2-3", suction: "12", ett: "6.5-7c", depth: "20-22", lma: "4" }
    ];

    const AIRWAY_BY_AGE = [
        { min: 0.083, max: 0.5, mask: "0", opaSize: "1", opaMm: "60", opaColor: "Black", blade: "Miller 1/Wis 1.5", suction: "8", ett: "3c/3.5", depth: "12", lma: "1-1.5" },
        { min: 0.5, max: 1, mask: "1", opaSize: "0", opaMm: "50", opaColor: "Lt Blue", blade: "Wis 1.5", suction: "8", ett: "3.5c/4u", depth: "13", lma: "1.5" },
        { min: 1, max: 2, mask: "1", opaSize: "1", opaMm: "60", opaColor: "Black", blade: "Wis 1.5", suction: "8", ett: "4-4.5c", depth: "14", lma: "2" },
        { min: 2, max: 4, mask: "2", opaSize: "1", opaMm: "60", opaColor: "Black", blade: "Wis 1.5/Mac 2", suction: "10", ett: "4.5c", depth: "15", lma: "2" },
        { min: 4, max: 6, mask: "2", opaSize: "1-2", opaMm: "60-70", opaColor: "Black/White", blade: "Miller 2/Mac 2", suction: "10", ett: "4.5-5c", depth: "16", lma: "2" },
        { min: 6, max: 8, mask: "2", opaSize: "2-3", opaMm: "70-80", opaColor: "White/Green", blade: "Miller 2/Mac 2", suction: "10", ett: "5-5.5c", depth: "17", lma: "2.5" },
        { min: 8, max: 12, mask: "3", opaSize: "3", opaMm: "80", opaColor: "Green", blade: "Miller/Mac 2-3", suction: "12", ett: "5.5-6c", depth: "18", lma: "3" },
        { min: 12, max: 999, mask: "4", opaSize: "3-4", opaMm: "80-90", opaColor: "Green/Yellow", blade: "Miller/Mac 2-3", suction: "12", ett: "6.5-7c", depth: "20-22", lma: "4" }
    ];

    function getWeightRange(gender, ageMonths) {
        const data = growthData[gender];
        if (!data || isNaN(ageMonths)) return "-";

        let closest = data[0];
        let minDiff = Math.abs(data[0][0] - ageMonths);

        for (let i = 1; i < data.length; i++) {
            const diff = Math.abs(data[i][0] - ageMonths);
            if (diff < minDiff) {
            minDiff = diff;
            closest = data[i];
            }
        }

        return `${closest[1].toFixed(1)} - ${closest[2].toFixed(1)} kg`;
    }

    function getAirwayData(value, dataset) {
        if (value === null || isNaN(value)) return null;
        for (let row of dataset) {
            if (value >= row.min && value < row.max) {
                return row;
            }
        }
        return null;
    }

    function formatColorText(colorStr) {
        if (!colorStr) return "";
        const colorMap = {
            "Black": "#000000",
            "White": "#7f8c8d", 
            "Pink": "#E91E63",
            "Lt Blue": "#00BFFF", 
            "Green": "#2ecc71",
            "Yellow": "#f1c40f",
            "Orange": "#e67e22",
            "Red": "#e74c3c",
            "Purple": "#9b59b6",
            "Blue": "#3498db"
        };
        const parts = colorStr.split('/');
        return parts.map(part => {
            let cCode = colorMap[part.trim()] || "#000";
            return `<span class="color-text" style="color:${cCode}">${part}</span>`;
        }).join('/');
    }

    function calculate() {
        let ageY = parseFloat(document.getElementById('ageYear').value);
        let ageM = parseFloat(document.getElementById('ageMonth').value);
        let weight = parseFloat(document.getElementById('weight').value);
        let height = parseFloat(document.getElementById('height').value);
        let gender = document.getElementById('gender').value;
        let ppHours = parseFloat(document.getElementById('ppHours').value) || 0;
        let relFactor = parseFloat(document.getElementById('relFactor').value) || 0;
        let hctInit = parseFloat(document.getElementById('hctInit').value) || 0;

        // EBV Override Inputs
        let ebvOverrideOn = document.getElementById('ebvOverrideToggle').checked;
        let ebvOverrideVal = parseFloat(document.getElementById('ebvOverrideValue').value);
        
        // MV Override Inputs
        let mvOverrideOn = document.getElementById('mvOverrideToggle').checked;
        let mvOverrideVal = parseFloat(document.getElementById('mvOverrideValue').value);

        let hasWeight = !isNaN(weight);
        let hasAge = !isNaN(ageY) || !isNaN(ageM);

        let valAgeY = (isNaN(ageY) ? 0 : ageY);
        let valAgeM = (isNaN(ageM) ? 0 : ageM);
        let totalMonths = (valAgeY * 12) + valAgeM;
        let totalYears = valAgeY + (valAgeM / 12);

        let estWDisplay = getWeightRange(gender, totalMonths);
        document.getElementById('resEstWeight').innerText = estWDisplay;

        // --- HYPOTENSION CALCULATOR LOGIC ---
        let minSBP = "-";
        // Rules:
        // <60: Term neonates (0-28 days approx <1 month)
        // <70: Infants (1-12 months)
        // <70 + 2*age: Children 1-10 years
        // <90: Children >= 10 years
        
        if (hasAge) {
            if (totalMonths < 1) {
                minSBP = "< 60 mm Hg";
            } else if (totalMonths <= 12) {
                minSBP = "< 70 mm Hg";
            } else if (valAgeY >= 1 && valAgeY < 10) {
                // Formula: 70 + (2 * age in years)
                let calc = 70 + (2 * valAgeY);
                minSBP = `< ${calc.toFixed(0)} mm Hg`;
            } else if (valAgeY >= 10) {
                minSBP = "< 90 mm Hg";
            }
        }
        document.getElementById('resMinSBP').innerText = minSBP;
        // -------------------------------------

        let pbw = 0;
        if (height > 0) {
            let base = gender === 'male' ? 50 : 45.5;
            pbw = base + 0.91 * (height - 152.4);
            document.getElementById('resPBW').innerText = pbw.toFixed(1) + " kg";
        } else {
            document.getElementById('resPBW').innerText = "-";
        }

        let wData = hasWeight ? getAirwayData(weight, AIRWAY_BY_WEIGHT) : null;
        let aData = hasAge ? getAirwayData(totalYears, AIRWAY_BY_AGE) : null;

        function renderDual(key) {
            let wVal = wData ? wData[key] : "-";
            let aVal = aData ? aData[key] : "-";
            return `
                <span class="calc-weight"><span class="calc-label">Wt</span> ${wVal}</span>
                <span class="calc-age"><span class="calc-label">Age</span> ${aVal}</span>
            `;
        }

        let ettHtml = "";
        let wEtt = wData ? wData.ett : "-";
        let aEtt = aData ? aData.ett : "-";
        ettHtml += `<span class="calc-weight"><span class="calc-label">Tab(Wt)</span> ${wEtt}</span>`;
        ettHtml += `<span class="calc-age"><span class="calc-label">Tab(Age)</span> ${aEtt}</span>`;

        if (totalYears > 0 && totalYears <= 8) {
            let duracherVal = (totalYears / 4) + 3.5;
            let coleVal = (totalYears / 4) + 4;
            ettHtml += `<span style="color:#27ae60; font-size:0.9em; margin-top:3px; border-top:1px dashed #eee; padding-top:2px; width:100%; text-align:right;">
                            <span class="calc-label">Duracher (Cuff)</span> ${duracherVal.toFixed(1)}
                        </span>`;
            ettHtml += `<span style="color:#d35400; font-size:0.9em;">
                            <span class="calc-label">Cole (Uncuff)</span> ${coleVal.toFixed(1)}
                        </span>`;
        } else if (totalYears > 8) {
             ettHtml += `<span style="color:#95a5a6; font-size:0.8em; margin-top:2px; border-top:1px dashed #eee; padding-top:2px; width:100%; text-align:right;">(Formulas Max 8yr)</span>`;
        }
        document.getElementById('resETT').innerHTML = ettHtml;

        document.getElementById('resDepth').innerHTML = renderDual('depth');
        document.getElementById('resBlade').innerHTML = renderDual('blade');
        document.getElementById('resLMA').innerHTML = renderDual('lma');
        document.getElementById('resMask').innerHTML = renderDual('mask');
        document.getElementById('resSuction').innerHTML = renderDual('suction');
        
        function renderOPA() {
            let wVal = "-";
            if (wData) {
                wVal = `${wData.opaSize}, ${wData.opaMm}mm, ${formatColorText(wData.opaColor)}`;
            }
            let aVal = "-";
            if (aData) {
                aVal = `${aData.opaSize}, ${aData.opaMm}mm, ${formatColorText(aData.opaColor)}`;
            }
            return `
                <span class="calc-weight"><span class="calc-label">Wt</span> ${wVal}</span>
                <span class="calc-age"><span class="calc-label">Age</span> ${aVal}</span>
            `;
        }
        document.getElementById('resOPA').innerHTML = renderOPA();

        let hr = "", rr = "";
        let vt = "";
        let mv = "-";

        if (hasWeight) {
            vt = (6 * weight).toFixed(0) + " - " + (8 * weight).toFixed(0) + " ml";
        }

        if (totalMonths < 1) { 
            hr = "120 - 170"; rr = "50 - 60";
        } else if (totalMonths <= 3) {
            hr = "100 - 150"; rr = "30 - 60";
        } else if (totalMonths <= 12) {
            hr = "80 - 120"; rr = "22 - 30";
        } else if (totalYears <= 3) {
            hr = "70 - 110"; rr = "18 - 24";
        } else if (totalYears <= 6) {
            hr = "65 - 110"; rr = "16 - 22";
        } else {
            hr = "60 - 95"; rr = "12 - 20";
        }

        document.getElementById('resHR').innerText = hr;
        document.getElementById('resRR').innerText = rr;
        document.getElementById('resVT').innerText = vt;
        
        // --- Minute Volume Logic ---
        let mvMin = 0; 
        let mvMax = 0;
        
        // Default factors
        if (totalMonths <= 1) {
            mvMin = 250; mvMax = 250;
        } else if (totalYears <= 16) {
            mvMin = 100; mvMax = 200;
        } else {
            mvMin = 80; mvMax = 100;
        }

        // Check Override
        const mvInput = document.getElementById('mvOverrideValue');
        const mvFactorDisplay = document.getElementById('resMVFactor');
        
        if (mvOverrideOn) {
            mvInput.style.display = "inline-block";
            if (!isNaN(mvOverrideVal) && mvOverrideVal > 0) {
                mvMin = mvOverrideVal;
                mvMax = mvOverrideVal;
            }
        } else {
            mvInput.style.display = "none";
            mvInput.value = "";
        }

        let mvFactorText = (mvMin === mvMax) ? `${mvMin}` : `${mvMin} - ${mvMax}`;
        mvFactorDisplay.innerText = mvFactorText + (mvOverrideOn ? " (Manual)" : "");
        if(mvOverrideOn) mvFactorDisplay.style.color = "#e74c3c";
        else mvFactorDisplay.style.color = "";

        if (hasWeight) {
            let totalMvMin = (mvMin * weight).toFixed(0);
            let totalMvMax = (mvMax * weight).toFixed(0);
            let totalMvText = (totalMvMin === totalMvMax) ? `${totalMvMin} ml/min` : `${totalMvMin} - ${totalMvMax} ml/min`;
            document.getElementById('resMV').innerText = totalMvText;
        } else {
            document.getElementById('resMV').innerText = "-";
        }
        // --- End MV Logic ---


        if (!hasWeight) {
            document.getElementById('resEBVFactor').innerText = "-";
            document.getElementById('resEBV').innerText = "-";
            document.getElementById('ablSection').innerHTML = "";
            document.getElementById('resMaint').innerText = "-";
            document.getElementById('resREL').innerText = "-";
            document.getElementById('resPP').innerText = "-";
            document.getElementById('resKC1').innerText = "-";
            document.getElementById('resKC2').innerText = "-";
            document.getElementById('resKC4').innerText = "-";
            document.getElementById('medsList').innerHTML = "";
            document.getElementById('resEpi').innerText = "-";
            document.getElementById('resEphedrine').innerText = "-";
            document.getElementById('resAtropine').innerText = "-";
            document.getElementById('resArmitageLow').innerText = "-";
            document.getElementById('resArmitageHigh').innerText = "-";
            return;
        }

        // EBV LOGIC WITH OVERRIDE
        let ebvFactorAuto = 75;
        if (valAgeY === 0 && valAgeM === 0) {
            ebvFactorAuto = 90;
        } else if (totalMonths < 1) {
            ebvFactorAuto = 85; 
        } else if (totalMonths < 12) {
            ebvFactorAuto = 80;
        } else if (gender === 'female' && totalYears > 12) {
            ebvFactorAuto = 65;
        }
        
        let ebvFactor = ebvFactorAuto;
        const ebvInput = document.getElementById('ebvOverrideValue');
        const ebvDisplay = document.getElementById('resEBVFactor');

        if (ebvOverrideOn) {
            ebvInput.style.display = "inline-block";
            if (!isNaN(ebvOverrideVal) && ebvOverrideVal > 0) {
                ebvFactor = ebvOverrideVal;
            }
        } else {
            ebvInput.style.display = "none";
            ebvInput.value = "";
        }

        let ebvLabel = ebvOverrideOn ? " ml/kg (Manual)" : " ml/kg (Auto)";
        ebvDisplay.innerText = ebvFactor + ebvLabel;

        if (ebvOverrideOn && ebvFactor < 50) {
            ebvDisplay.style.color = "#e74c3c";
        } else {
            ebvDisplay.style.color = "";
        }

        let ebv = weight * ebvFactor;
        document.getElementById('resEBV').innerText = ebv.toFixed(0) + " ml";
        
        // ABL Calculation Loop
        let ablHtml = "";
        if (hctInit > 0) {
            const ablTargets = [
                { hct: 30, label: "Hb 10 = 30% hct" },
                { hct: 27, label: "Hb 9 = 27% hct" },
                { hct: 24, label: "Hb 8 = 24% hct" },
                { hct: 21, label: "Hb 7 = 21% hct" },
                { hct: 18, label: "Hb 6 = 18% hct" }
            ];

            ablTargets.forEach(t => {
                let val = 0;
                if (hctInit > t.hct) {
                    val = (ebv * (hctInit - t.hct)) / hctInit;
                    ablHtml += `<div class="result-row"><span class="result-label">${t.label}</span><span class="result-value">${val.toFixed(0)} ml</span></div>`;
                } else {
                     ablHtml += `<div class="result-row"><span class="result-label">${t.label}</span><span class="result-value">-</span></div>`;
                }
            });
            
            // Deltas
            let d15 = ebv * 0.15;
            ablHtml += `<div class="result-row"><span class="result-label">Delta Hb or hct 15%</span><span class="result-value">${d15.toFixed(0)} ml</span></div>`;
            
            let d30 = ebv * 0.30;
            ablHtml += `<div class="result-row"><span class="result-label">Delta Hb or hct 30%</span><span class="result-value">${d30.toFixed(0)} ml</span></div>`;
            
        } else {
            ablHtml = `<div class="result-row" style="color:#e67e22; justify-content:center; text-align:center;">Masukkan Hct Awal</div>`;
        }
        document.getElementById('ablSection').innerHTML = ablHtml;

        let maint = 2 * weight;
        
        document.getElementById('resMaint').innerText = maint.toFixed(0) + " ml/hr";

        let pp = maint * ppHours;
        let rel = relFactor * weight; 
        
        document.getElementById('resREL').innerText = rel.toFixed(0) + " ml/hr";
        document.getElementById('resPP').innerText = pp.toFixed(0) + " ml";

        let kc1 = maint + rel + (0.5 * pp);
        let kc2 = maint + rel + (0.25 * pp);
        let kc4 = maint + rel;

        document.getElementById('resKC1').innerText = kc1.toFixed(0) + " ml";
        document.getElementById('resKC2').innerText = kc2.toFixed(0) + " ml";
        document.getElementById('resKC4').innerText = kc4.toFixed(0) + " ml";

        let meds = [
            { name: "Midazolam", dose: 0.05, unit: "mg" },
            { name: "Fentanyl", dose: "1-2", unit: "mcg", isRange: true, min: 1, max: 2 },
            { name: "Propofol", dose: "1-2", unit: "mg", isRange: true, min: 1, max: 2 },
            { name: "Atracurium", dose: 0.5, unit: "mg" },
            { name: "Rocuronium", dose: "0.6-1.2", unit: "mg", isRange: true, min: 0.6, max: 1.2 },
            { name: "Ketamine", dose: "1-2", unit: "mg", isRange: true, min: 1, max: 2 },
            { name: "Paracetamol", dose: 15, unit: "mg" },
            { name: "Dexamethasone", dose: "0.1-0.5", unit: "mg", isRange: true, min: 0.1, max: 0.5 },
            { name: "Neostigmine", dose: "0.04-0.07", unit: "mg", isRange: true, min: 0.04, max: 0.07 }
        ];

        let medsHtml = "";
        meds.forEach(med => {
            let val = "";
            if (med.isRange) {
                let v1 = (med.min * weight);
                let v2 = (med.max * weight);
                v1 = v1 < 10 ? v1.toFixed(1) : v1.toFixed(0);
                v2 = v2 < 10 ? v2.toFixed(1) : v2.toFixed(0);
                val = `${v1} - ${v2} ${med.unit}`;
            } else {
                let v = (med.dose * weight);
                v = v < 10 ? v.toFixed(1) : v.toFixed(0);
                val = `${v} ${med.unit}`;
            }
            medsHtml += `<div class="result-row"><span class="result-label">${med.name} (${med.dose} ${med.unit}/kg)</span><span class="result-value">${val}</span></div>`;
        });
        document.getElementById('medsList').innerHTML = medsHtml;

        let epi = (10 * weight);
        document.getElementById('resEpi').innerText = epi + " mcg (" + (epi/1000).toFixed(2) + " mg)";
        
        let ephMin = (0.1 * weight).toFixed(1);
        let ephMax = (0.3 * weight).toFixed(1);
        document.getElementById('resEphedrine').innerText = `${ephMin} - ${ephMax} mg`;

        let atrMin = (0.01 * weight).toFixed(2);
        let atrMax = (0.02 * weight).toFixed(2);
        document.getElementById('resAtropine').innerText = `${atrMin} - ${atrMax} mg`;

        document.getElementById('resArmitageLow').innerText = (0.5 * weight).toFixed(1) + " ml";
        document.getElementById('resArmitageHigh').innerText = (1.0 * weight).toFixed(1) + " ml";
    }
</script>

</body>
</html>```

